#!/bin/bash

# Vanta Ledger Database Installation Script
# =========================================
# This script sets up the hybrid database architecture for Vanta Ledger
# with PostgreSQL, MongoDB, and Redis - NO DUPLICATES

set -e

echo "🚀 Vanta Ledger Database Installation"
echo "====================================="

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "❌ Docker is not running. Please start Docker and try again."
    exit 1
fi

# Check if .env file exists
if [ ! -f ".env" ]; then
    echo "❌ .env file not found. Please copy env.example to .env and configure it."
    exit 1
fi

echo "✅ Docker is running"
echo "✅ Environment file found"

# Stop any existing containers
echo "🛑 Stopping any existing containers..."
docker ps -q --filter "name=vanta_ledger" | xargs -r docker stop 2>/dev/null || true
docker ps -aq --filter "name=vanta_ledger" | xargs -r docker rm 2>/dev/null || true

# Remove any existing volumes
echo "🧹 Cleaning up existing volumes..."
docker volume ls -q --filter "name=database_" | xargs -r docker volume rm 2>/dev/null || true

# Start the hybrid database system
echo "🚀 Starting hybrid database system..."
docker-compose -f docker-compose-hybrid.yml up -d

# Wait for services to be ready
echo "⏳ Waiting for services to be ready..."
sleep 30

# Check service health
echo "🔍 Checking service health..."
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo ""
echo "✅ Database installation complete!"
echo ""
echo "📊 Database Services:"
echo "   • PostgreSQL: localhost:5432"
echo "   • MongoDB: localhost:27017"
echo "   • Redis: localhost:6379"
echo ""
echo "🛠️  Management Interfaces:"
echo "   • pgAdmin: http://localhost:8080"
echo "   • Mongo Express: http://localhost:8081"
echo ""
echo "🔐 Default Credentials:"
echo "   • PostgreSQL: vanta_user / (from .env)"
echo "   • MongoDB: admin / (from .env)"
echo "   • pgAdmin: admin@vantaledger.com / (from .env)"
echo "   • Mongo Express: admin / (from .env)"
echo ""
echo "📋 Next Steps:"
echo "   1. Run: python3 hybrid_database_setup.py"
echo "   2. Check: python3 check_status.py"
echo "   3. Access management interfaces"
echo ""
echo "🎉 Vanta Ledger database is ready!"
