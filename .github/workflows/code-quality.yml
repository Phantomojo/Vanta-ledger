name: ðŸ” Code Quality & Standards

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run code quality checks daily at 8 AM UTC
    - cron: '0 8 * * *'

jobs:
  code-formatting:
    name: ðŸŽ¨ Code Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ”§ Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort yapf autopep8
        
    - name: ðŸŽ¨ Check Black formatting
      run: |
        echo "ðŸŽ¨ Checking Black code formatting..."
        black --check --diff .
        
    - name: ðŸ”„ Check isort import sorting
      run: |
        echo "ðŸ”„ Checking import sorting..."
        isort --check-only --diff .
        
    - name: ðŸ“ Auto-format code (if needed)
      run: |
        echo "ðŸ“ Auto-formatting code..."
        black .
        isort .
        
    - name: ðŸ“¤ Commit formatting changes
      if: failure()
      run: |
        echo "ðŸ“¤ Committing formatting changes..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ðŸŽ¨ Auto-format code with Black and isort" || echo "No changes to commit"
        git push || echo "Push failed"

  linting:
    name: ðŸ” Linting & Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ”§ Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint pycodestyle pydocstyle
        
    - name: ðŸ” Run Flake8
      run: |
        echo "ðŸ” Running Flake8 linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
        
    - name: ðŸ” Run PyLint
      run: |
        echo "ðŸ” Running PyLint analysis..."
        pylint src/ --output-format=text --reports=y || true
        
    - name: ðŸ” Run PyCodeStyle
      run: |
        echo "ðŸ” Running PyCodeStyle checks..."
        pycodestyle src/ --max-line-length=88 || true
        
    - name: ðŸ“š Run PyDocStyle
      run: |
        echo "ðŸ“š Running PyDocStyle checks..."
        pydocstyle src/ --ignore=D100,D104,D106,D200,D203,D212,D401,D406,D407,D413 || true

  type-checking:
    name: ðŸ” Type Checking
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ”§ Install type checking tools
      run: |
        python -m pip install --upgrade pip
        pip install mypy pyright pytype
        
    - name: ðŸ” Run MyPy
      run: |
        echo "ðŸ” Running MyPy type checking..."
        mypy src/ --ignore-missing-imports --show-error-codes
        
    - name: ðŸ” Run Pyright
      run: |
        echo "ðŸ” Running Pyright type checking..."
        npx pyright src/ || echo "Pyright not available, skipping..."
        
    - name: ðŸ” Run PyType
      run: |
        echo "ðŸ” Running PyType type checking..."
        pytype src/ || echo "PyType not available, skipping..."

  complexity-analysis:
    name: ðŸ“Š Code Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ”§ Install complexity tools
      run: |
        python -m pip install --upgrade pip
        pip install radon mccabe xenon
        
    - name: ðŸ“Š Run Radon complexity analysis
      run: |
        echo "ðŸ“Š Running Radon complexity analysis..."
        radon cc src/ -a -nc
        radon mi src/ -nc
        radon hal src/ -nc
        
    - name: ðŸ“Š Run McCabe complexity
      run: |
        echo "ðŸ“Š Running McCabe complexity analysis..."
        python -m mccabe src/ --min 10 || true
        
    - name: ðŸ“Š Run Xenon complexity check
      run: |
        echo "ðŸ“Š Running Xenon complexity check..."
        xenon --max-absolute A --max-modules A --max-average A src/ || true

  documentation-check:
    name: ðŸ“š Documentation Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ðŸ”§ Install documentation tools
      run: |
        python -m pip install --upgrade pip
        pip install pydocstyle doc8 sphinx
        
    - name: ðŸ“š Check docstring coverage
      run: |
        echo "ðŸ“š Checking docstring coverage..."
        python -c "
        import os
        import ast
        
        def count_functions_and_classes(file_path):
            with open(file_path, 'r') as f:
                tree = ast.parse(f.read())
            
            functions = len([n for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)])
            classes = len([n for n in ast.walk(tree) if isinstance(n, ast.ClassDef)])
            return functions, classes
        
        def count_docstrings(file_path):
            with open(file_path, 'r') as f:
                tree = ast.parse(f.read())
            
            docstrings = len([n for n in ast.walk(tree) if isinstance(n, ast.Constant) and isinstance(n.value, str)])
            return docstrings
        
        total_functions = 0
        total_classes = 0
        total_docstrings = 0
        
        for root, dirs, files in os.walk('src'):
            for file in files:
                if file.endswith('.py'):
                    file_path = os.path.join(root, file)
                    try:
                        funcs, classes = count_functions_and_classes(file_path)
                        docstrings = count_docstrings(file_path)
                        total_functions += funcs
                        total_classes += classes
                        total_docstrings += docstrings
                    except:
                        pass
        
        print(f'Total functions: {total_functions}')
        print(f'Total classes: {total_classes}')
        print(f'Total docstrings: {total_docstrings}')
        print(f'Documentation coverage: {total_docstrings/(total_functions + total_classes)*100:.1f}%')
        "
        
    - name: ðŸ“š Check README and docs
      run: |
        echo "ðŸ“š Checking documentation files..."
        if [ -f "README.md" ]; then
          echo "âœ… README.md found"
        else
          echo "âŒ README.md missing"
        fi
        
        if [ -d "docs/" ]; then
          echo "âœ… docs/ directory found"
          find docs/ -name "*.md" | wc -l | xargs echo "ðŸ“„ Number of markdown files:"
        else
          echo "âŒ docs/ directory missing"
        fi

  quality-summary:
    name: ðŸ“Š Quality Summary
    runs-on: ubuntu-latest
    needs: [code-formatting, linting, type-checking, complexity-analysis, documentation-check]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Generate quality summary
      run: |
        echo "ðŸ“Š Generating code quality summary..."
        
        echo "# ðŸ” Code Quality Summary" > quality-summary.md
        echo "Generated: $(date)" >> quality-summary.md
        echo "" >> quality-summary.md
        
        echo "## ðŸ“‹ Quality Check Results" >> quality-summary.md
        echo "- Code Formatting: ${{ needs.code-formatting.result }}" >> quality-summary.md
        echo "- Linting: ${{ needs.linting.result }}" >> quality-summary.md
        echo "- Type Checking: ${{ needs.type-checking.result }}" >> quality-summary.md
        echo "- Complexity Analysis: ${{ needs.complexity-analysis.result }}" >> quality-summary.md
        echo "- Documentation: ${{ needs.documentation-check.result }}" >> quality-summary.md
        echo "" >> quality-summary.md
        
        echo "## ðŸŽ¯ Quality Metrics" >> quality-summary.md
        echo "- Code formatting compliance: ${{ needs.code-formatting.result == 'success' && 'âœ…' || 'âŒ' }}" >> quality-summary.md
        echo "- Linting standards: ${{ needs.linting.result == 'success' && 'âœ…' || 'âŒ' }}" >> quality-summary.md
        echo "- Type safety: ${{ needs.type-checking.result == 'success' && 'âœ…' || 'âŒ' }}" >> quality-summary.md
        echo "- Code complexity: ${{ needs.complexity-analysis.result == 'success' && 'âœ…' || 'âŒ' }}" >> quality-summary.md
        echo "- Documentation coverage: ${{ needs.documentation-check.result == 'success' && 'âœ…' || 'âŒ' }}" >> quality-summary.md
        echo "" >> quality-summary.md
        
        echo "## ðŸš€ Recommendations" >> quality-summary.md
        if [ "${{ needs.code-formatting.result }}" != "success" ]; then
          echo "- ðŸŽ¨ Fix code formatting issues with Black and isort" >> quality-summary.md
        fi
        if [ "${{ needs.linting.result }}" != "success" ]; then
          echo "- ðŸ” Address linting violations and code style issues" >> quality-summary.md
        fi
        if [ "${{ needs.type-checking.result }}" != "success" ]; then
          echo "- ðŸ” Fix type annotation issues and improve type safety" >> quality-summary.md
        fi
        if [ "${{ needs.complexity-analysis.result }}" != "success" ]; then
          echo "- ðŸ“Š Reduce code complexity in identified functions" >> quality-summary.md
        fi
        if [ "${{ needs.documentation-check.result }}" != "success" ]; then
          echo "- ðŸ“š Improve documentation coverage and quality" >> quality-summary.md
        fi
        
        if [ "${{ needs.code-formatting.result }}" == "success" ] && [ "${{ needs.linting.result }}" == "success" ] && [ "${{ needs.type-checking.result }}" == "success" ] && [ "${{ needs.complexity-analysis.result }}" == "success" ] && [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "- ðŸŽ‰ All quality checks passed! Code meets high standards." >> quality-summary.md
        fi
        
    - name: ðŸ“¤ Upload quality summary
      uses: actions/upload-artifact@v3
      with:
        name: quality-summary
        path: quality-summary.md
        retention-days: 30
